# ================================================================
# CI — Notification Service
#
# Déclenché uniquement si services/notification/** est modifié.
#
# PIPELINE :
#   1. test   → vitest (unit tests)
#   2. build  → image Docker validée sans push
#
# COHÉRENCE :
#   Même structure que ci-auth, ci-order, ci-product, ci-payment.
#   - Le job build attend la fin du job test (needs: test)
#   - push: false → aucun push vers un registry (CI only)
#   - Cache Docker layers pour accélérer les builds successifs
#
# PRÉREQUIS — Secrets GitHub :
#   Aucun secret requis pour le CI (pas de push registry).
# ================================================================

name: CI — Notification Service

on:
  push:
    branches: [main, develop, "feature/**", "fix/**"]
    paths:
      - "services/notification/**"
      - ".github/workflows/ci-notification.yaml"
  pull_request:
    branches: [main, develop]
    paths:
      - "services/notification/**"

concurrency:
  group: ci-notification-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 1 — TESTS
  #
  # Exécute les tests unitaires Vitest dans un container Node.js.
  # Les dépendances sont cachées par npm ci pour accélérer les runs suivants.
  #
  # Variables d'environnement fictives : les tests unitaires ne doivent pas
  # dépendre d'une DB, Redis ou API tierce réelle.
  # ────────────────────────────────────────────────────────────────────────────

  test:
    name: Run Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: services/notification

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: services/notification/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:run
        env:
          NODE_ENV: test
          # Variables minimales pour satisfaire environment.js au démarrage.
          # Les tests unitaires mockent les dépendances externes (DB, Redis, Resend).
          PORT: 3007
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://ci:ci@localhost:5432/ci_notification
          RESEND_API_KEY: re_ci_not_real
          INTERNAL_NOTIFICATION_SECRET: ci-internal-secret-not-used-in-production
          CLIENT_URL: http://localhost:5173

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 2 — BUILD DOCKER IMAGE
  #
  # Valide que le Dockerfile se construit sans erreur depuis le code source.
  # Déclenché uniquement si les tests passent.
  # push: false → aucun push vers un registry (CI only).
  # ────────────────────────────────────────────────────────────────────────────

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Build Notification Service image
        uses: docker/build-push-action@v5
        with:
          context: ./services/notification
          file: ./services/notification/Dockerfile
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ecom-watch-notification:ci
