# ================================================================
# ECOM-WATCH GATEWAY — vhost principal
# ================================================================

server {
    listen      ${PORT};  # Render injecte PORT dynamiquement
    server_name _;

    # ── Taille max body (uploads Cloudinary passent par ici) ───────
    client_max_body_size 10M;

    # ── CORS — frontend Vercel ─────────────────────────────────────
    # Centralisé ici : le monolithe n'a plus besoin de gérer CORS
    set $cors_origin "";
    if ($http_origin ~* "^https://(.*\.vercel\.app|${FRONTEND_DOMAIN})$") {
        set $cors_origin $http_origin;
    }

    # Preflight OPTIONS — réponse directe sans toucher le monolithe
    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin      $cors_origin always;
        add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers     "Authorization, Content-Type, X-Request-ID" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Max-Age           "86400" always;
        return 204;
    }

    # ── Health check Gateway (ne passe pas par le monolithe) ───────
    location = /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"ok","service":"api-gateway","version":"1.0.0"}';
    }

    # ── Routes auth — rate limit strict (login/register) ──────────
    location ~ ^/api/v1/auth/(login|register|forgot-password) {
        limit_req zone=auth burst=5 nodelay;
        limit_req_status 429;

        include /etc/nginx/conf.d/proxy_params.conf;
        proxy_pass http://monolith;
    }

    # ── Toutes les autres routes API ───────────────────────────────
    location /api/v1/ {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;

        include /etc/nginx/conf.d/proxy_params.conf;
        proxy_pass http://monolith;
    }

    # ── Route inconnue ─────────────────────────────────────────────
    location / {
        add_header Content-Type application/json;
        return 404 '{"error":"Not found","message":"Route inexistante sur le Gateway"}';
    }
}