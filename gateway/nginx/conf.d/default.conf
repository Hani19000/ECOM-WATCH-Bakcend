server {
    listen      ${PORT};
    server_name _;

    client_max_body_size 10M;

    # ── Supprime les headers CORS upstream pour éviter les doublons ──
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Max-Age;

    # ── CORS headers gérés uniquement par le Gateway ─────────────────
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers     "Authorization, Content-Type, X-Request-ID" always;
    add_header Access-Control-Max-Age           "86400" always;
    add_header X-Gateway                        "ecom-watch" always;

    # ── Preflight OPTIONS ─────────────────────────────────────────────
    if ($request_method = OPTIONS) {
        return 204;
    }

    # ── Health check Gateway ──────────────────────────────────────────
    location = /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"ok","service":"api-gateway","version":"1.0.0"}';
    }

    # ─────────────────────────────────────────────────────────────────
    # BLOCAGE DES ROUTES INTERNES
    # Les routes /internal/* ne sont jamais exposées à Internet.
    # Elles ne transitent qu'en réseau interne Render (service-to-service).
    # ─────────────────────────────────────────────────────────────────
    location ~ ^/internal/ {
        return 404;
    }

    # ─────────────────────────────────────────────────────────────────
    # AUTH-SERVICE — /auth/* et /users/*
    # ─────────────────────────────────────────────────────────────────

    # Rate limit strict sur les routes sensibles (login, register...)
    location ~ ^/(api/v1/)?auth/(login|register|forgot-password|reset-password) {
        limit_req zone=auth burst=5 nodelay;
        limit_req_status 429;
        include /tmp/nginx/conf.d/proxy_params.conf;
        proxy_pass https://auth_service;
        proxy_ssl_server_name on;
        proxy_ssl_name ${AUTH_SERVICE_HOST};
        proxy_set_header Host ${AUTH_SERVICE_HOST};
    }

    # Refresh, logout et autres routes auth
    location ~ ^/(api/v1/)?auth {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;
        include /tmp/nginx/conf.d/proxy_params.conf;
        proxy_pass https://auth_service;
        proxy_ssl_server_name on;
        proxy_ssl_name ${AUTH_SERVICE_HOST};
        proxy_set_header Host ${AUTH_SERVICE_HOST};
    }

    # Profil utilisateur et administration
    location ~ ^/(api/v1/)?users {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;
        include /tmp/nginx/conf.d/proxy_params.conf;
        proxy_pass https://auth_service;
        proxy_ssl_server_name on;
        proxy_ssl_name ${AUTH_SERVICE_HOST};
        proxy_set_header Host ${AUTH_SERVICE_HOST};
    }

    # ─────────────────────────────────────────────────────────────────
    # ORDER-SERVICE — /orders/* UNIQUEMENT
    #
    # IMPORTANT : cart, payments, shipping, taxes restent sur le monolith.
    # L'order-service calcule shipping et taxes en interne (pas de routes
    # HTTP exposées pour ça). Seul /orders/* lui appartient.
    # ─────────────────────────────────────────────────────────────────

    # Rate limit strict sur le suivi guest (anti-énumération)
    location ~ ^/(api/v1/)?orders/track-guest {
        limit_req zone=auth burst=5 nodelay;
        limit_req_status 429;
        include /tmp/nginx/conf.d/proxy_params.conf;
        proxy_pass https://order_service;
        proxy_ssl_server_name on;
        proxy_ssl_name ${ORDER_SERVICE_HOST};
        proxy_set_header Host ${ORDER_SERVICE_HOST};
    }

    # Toutes les autres routes orders → order-service
    location ~ ^/(api/v1/)?orders {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;
        include /tmp/nginx/conf.d/proxy_params.conf;
        proxy_pass https://order_service;
        proxy_ssl_server_name on;
        proxy_ssl_name ${ORDER_SERVICE_HOST};
        proxy_set_header Host ${ORDER_SERVICE_HOST};
    }

    # ─────────────────────────────────────────────────────────────────
    # MONOLITHE — fallback
    # Tout ce qui ne correspond pas aux services ci-dessus :
    # products, cart, payments, shipping, taxes, inventory,
    # admin, promotions, categories, sitemap...
    # ─────────────────────────────────────────────────────────────────
    location / {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;
        include /tmp/nginx/conf.d/proxy_params.conf;
        proxy_pass https://monolith;
        proxy_ssl_server_name on;
        proxy_ssl_name ${MONOLITH_URL};
        proxy_set_header Host ${MONOLITH_URL};
    }
}