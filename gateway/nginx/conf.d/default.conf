server {
    listen      ${PORT};
    server_name _;

    client_max_body_size 10M;

    # ── CORS headers au niveau server (s'appliquent à toutes les réponses)
    add_header Access-Control-Allow-Origin      $cors_origin always;
    add_header Access-Control-Allow-Credentials "true"       always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers     "Authorization, Content-Type, X-Request-ID" always;
    add_header Access-Control-Max-Age           "86400" always;

    # ── Preflight OPTIONS — return direct, les headers server s'appliquent
    if ($request_method = OPTIONS) {
        return 204;
    }

    # ── Health check
    location = /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"ok","service":"api-gateway","version":"1.0.0"}';
    }

    # ── Auth — rate limit strict
    location ~ ^/api/v1/auth/(login|register|forgot-password) {
        limit_req zone=auth burst=5 nodelay;
        limit_req_status 429;
        include /tmp/nginx/conf.d/proxy_params.conf;
        proxy_pass https://monolith;
        proxy_ssl_server_name on;
        proxy_set_header Host ${MONOLITH_URL};
    }

    # ── Toutes les autres routes API
    location /api/v1/ {
        limit_req zone=api burst=20 nodelay;
        limit_req_status 429;
        include /tmp/nginx/conf.d/proxy_params.conf;
        proxy_pass https://monolith;
        proxy_ssl_server_name on;
        proxy_set_header Host ${MONOLITH_URL};
    }

    # ── Route inconnue
    location / {
        add_header Content-Type application/json;
        return 404 '{"error":"Not found"}';
    }
}